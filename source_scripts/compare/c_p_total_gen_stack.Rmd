
```{r total_gen_stack, include=TRUE}

for ( i in 1:n.files ) {
  
  # Query annual generation by type.
  yr.gen = tryCatch( gen_by_type(get(paste0('SC', i, '.yr.data.generator'))), error = function(cond) { return('ERROR') } )
  
  # If the query doesn't work, print an error. Else create the plot.
  if ( typeof(yr.gen)=='character' ) {
    print('ERROR: gen_by_type function not returning correct results.')
  } else {
    
    # # gen.sum is just used to set the maximum height on the plot, see pretty() fcn below
    # gen.sum = yr.gen %>%
    #   dplyr::summarise(TWh=sum(GWh)/1000) #change GWh generation to TWh
  
    # reorder the levels of Type to plot them in order
    yr.gen$Type = factor(yr.gen$Type, levels = c(gen.order))
    if(any(is.na(yr.gen$Type))) print("ERROR:gen.order doesn't contain all of the gen types: FIX YOUR INPUT DATA CSV")
  
    gen.plot = yr.gen %>%
      group_by(Type) %>%
      dplyr::summarise(TWh=sum(GWh)/1000)
    
    if ( i == 1 ) {
      # Group by type and convert GWh to TWh
      gen.plot.compare = gen.plot
      gen.plot.base = gen.plot$TWh
      gen.plot.compare$TWh = 0
      colnames(gen.plot.compare)[colnames(gen.plot.compare)=='TWh']='Base'
    } else {
      gen.plot.compare = cbind(gen.plot.compare, gen.plot$TWh-gen.plot.base)
      names(gen.plot.compare)[i+1] = paste0('SC', i)
    }

    # tot.load = sum(r.load$value)/1000
    
    # # This automatically creates the y-axis scaling
    # py=pretty(gen.sum$TWh, n=5, min.n = 5)
    # seq.py=seq(0, py[length(py)], 10*(py[2]-py[1]))
  
  }
}

plot.data = melt(gen.plot.compare, id.vars = 'Type', variable.name = 'Run')
plot.data.pos = plot.data[plot.data$value>=0,]
plot.data.neg = plot.data[plot.data$value<0,]

# Create plot
ggplot() +
       geom_bar(data = plot.data.pos, aes(x = Run, y = value, fill=Type, order=as.numeric(Type)), stat="identity", position="stack" ) +
       geom_bar(data = plot.data.neg, aes(x = Run, y = value, fill=Type, order=as.numeric(Type)), stat='identity', position='stack' ) +
       geom_hline(aes(yintercept=0), color='black', size=0.45, linetype='longdash')+
       scale_fill_manual('', values = gen.color, limits=rev(gen.order))+
       labs(y="Generation (TWh)", x=NULL)+
       # scale_y_continuous(breaks=seq.py, limits=c(0, max(py)), expand=c(0,0), label=comma)+
       guides(color = guide_legend(order=1), fill = guide_legend(order=2))+
       theme(    legend.key =      element_rect(color="grey80", size = 0.8),
                 legend.key.size = grid::unit(1.0, "lines"),
                 legend.text =     element_text(size=text.plot),
                 legend.title =    element_blank(),
         #                         text = element_text(family="Arial"),
                 axis.text =       element_text(size=text.plot/1.2),
                 # axis.text.x =   element_text(face=2),
                 axis.title =      element_text(size=text.plot, face=2),
                 axis.title.y =    element_text(vjust=1.2),
                 panel.spacing =    unit(1.5, "lines"),
                 aspect.ratio =    2.5 )

```
