
```{r region_gen_stacks, include=TRUE, fig.width=8, fig.height=10}

if( !exists('zone.gen') ) {
  # Query region and zonal generation
  region.gen = tryCatch( select(region_zone_gen(), Region, Zone, Type, GWh = value), error = function(cond) { return('ERROR') } )
} else {
  region.gen = zone.gen
}

# Check if zonal.gen query worked and create plot of regional gen, else return an error.
if ( typeof(region.gen)=='character' ) {
  print('ERROR: region_zone_gen function not returning correct results.')
} else {
  
  # reorder the levels of Type to plot them in order
  region.gen$Type = factor(region.gen$Type, levels = gen.order)
    
  # zone.gen.sum is just used to set the maximum height on the plot, see pretty() fcn below
  region.gen.sum = region.gen %>% 
    dplyr::summarise(TWh=sum(GWh)/1000) #change GWh generation to TWh
  
  # Convert GWh to TWh
  region.gen.plot = region.gen %>%
    group_by(Type, Region, Zone) %>%
    dplyr::summarise(TWh = sum(GWh)/1000) %>%
    filter(Zone != 'BHUTAN')
    
  region.load = filter(r.z.load, Type == 'Region')
  colnames(region.load)[which(colnames(region.load)=='name')]='Region'
  region.load$value = region.load$value/1000
  region.load$Type = NULL
  region.load = region.load %>%
    join(region.zone.mapping[,c('Zone', 'Region')], by = 'Region', type='left', match='first') %>%
    filter(Zone != 'BHUTAN')
  region.load = region.load[complete.cases(region.load),]
  
  # *** Not needed for these plots as y-axis is varying. ***
  # # This automatically creates the y-axis scaling
  # py=pretty(region.gen.sum$TWh, n=5, min.n = 5)
  # seq.py=seq(0, py[length(py)], 10*(py[2]-py[1]))
  
  # Create plot
  ggplot() +
    geom_bar(data = region.gen.plot, aes(x = Region, y = TWh, fill=Type, order=as.numeric(Type)), stat='identity', position="stack" ) +
    geom_errorbar(aes(x=Region, y=value, ymin=value, ymax=value, color='load'), data=region.load, linetype='longdash', size=0.45)+
    scale_fill_manual(values = gen.color, guide = guide_legend(reverse = TRUE))+
    scale_color_manual(name='', values=c("load"="grey40"), labels=c("Load"))+
    labs(y="Generation (TWh)", x=NULL)+
    # scale_y_continuous(breaks=seq.py, expand=c(0,0), label=comma)+
    guides(color = guide_legend(order=1), fill = guide_legend(order=2, reverse=TRUE))+
         theme(    legend.key =      element_rect(color="grey80", size = 0.8), 
                   legend.key.size = grid::unit(1.0, "lines"),
                   legend.text =     element_text(size=text.plot), 
                   legend.title =    element_blank(),
           #                         text = element_text(family="Arial"),
                   axis.text =       element_text(size=text.plot/1.2), 
                   axis.text.x =     element_text(angle=-45, hjust=0),
                   axis.title =      element_text(size=text.plot, face=2), 
                   axis.title.y =    element_text(vjust=1.2), 
                   panel.margin =    unit(1.5, "lines"))+
        facet_wrap(~Zone, scales = 'free', ncol=2)
                   # , nrow=length(unique(region.gen.plot$Zone)))
}
```
