---
title: "Multi-area Grid Metrics Analyzer"
author: "Created by: National Renewable Energy Laboratory (NREL)"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document: 
    css: custom.css
    toc: yes
---

```{r setOptions, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# Set up default options for chunks, turn off error or warning messages.
knitr::opts_chunk$set(echo=FALSE, comment=NA, warning=FALSE, message=FALSE, include=TRUE,
                      fig.path=fig.path.name, dev='png')

# Set dynamic height for figure in regional generation chunk
if (exists('zone.names')) { 
  f.height = ( length(zone.names) %/% 2 + length(zone.names) %% 2 ) * 5
  # f.height = 5
  } else { f.height = 5 }
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

### Data below generated for:
"`r gsub('.*Model', 'Model', db$filename)`"

***
## Annual Dispatch Stacks 
***
## 1. Total Generation
```{r total-gen-stack}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/p_total_gen_stack.R')
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 2. Zonal Generation
```{r zone-gen-stacks, resize.height=T}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/p_zone_gen_stacks.R')
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 3. Regional Generation
```{r region-gen-stacks, resize.height=F, fig.height=f.height}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/p_region_gen_stacks.R')
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 4. Individual Regions
```{r individual-region-stacks, include=FALSE}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# Check if this section was selected to run in the input file
if(individual.region.stacks.log) {
  
  # Source R script which calls region_zone_gen function and creates data for plots
  source('source_scripts/d_individual_region_stacks.R')
  
  # As long as the file exists (previous source found the R script) this loop runs
  if ( exists('r.z.gen.plot') ) {
    # If the regional query didn't work, return an error. Else create the plots by calling the markdown file.
    if ( typeof(r.z.gen.plot)=='character' ) {
      print('ERROR: region_zone_gen function not returning correct results.')
    # If regional load query from the setup_dataQueries file didn't work, the loop ends here.
    } else if ( typeof(r.load) == 'character' ) {
      print('ERROR: region_load function not returning correct results.')
    } else {
    
        key.plots = list() # Creates empty list for plot data
    
        plot.regions = region.names[!region.names %in% ignore.regions]
        # Create plot for each region in region.names
        for ( p in 1:length(plot.regions) )  {
          region.name = plot.regions[p]
          key.plots[p] = knit_expand(file = 'source_scripts/p_individual_region_stacks.Rmd', region.name=region.name)
        }
    
        # Reconstruct the plot data into a format that will be output into the HTML below
        individual.region.stacks = knit_child(text = unlist(key.plots))
    }
  }
} else { individual.region.stacks = 'Section not run according to input file.' }
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```
`r individual.region.stacks`

***
## 5-7. Specified Period Dispatch Stacks
``` {r key-period-dispatch, cache=FALSE, include=FALSE}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# Check if this section was selected to run in the input file
if (key.period.dispatch.total.log | key.period.dispatch.zone.log | key.period.dispatch.region.log){  

  # Call interval_gen function and proces data for plots
  source('source_scripts/d_key_period_dispatch.R')

  # As long as the file exists (previous source found the R script) this loop runs
  if ( exists('key.period.gen') ) {
  # Check to see if the right data is ready for plotting.
    if ( typeof(key.period.gen)=='character' ) {
      key.period.dispatch.total  = 'ERROR: interval_gen function not returning correct results.'
      key.period.dispatch.zone   = 'ERROR: interval_gen function not returning correct results.'
      key.period.dispatch.region = 'ERROR: interval_gen function not returning correct results.'
    } else {
  
      key.plots.total = list() # Creates empty list for plot data
      key.plots.zone = list() # Creates empty list for plot data
      key.plots.region = list() # Creates empty list for plot data
      r.idx = 1
      z.idx = 1
      
      # Create data for each plot for the interesting periods
      for ( p in 1:n.periods ) {
        period.name = period.names[p]
        
        # Check if total database info was selected in input file.
        if (key.period.dispatch.total.log) {
          key.plots.total[[p]] = knit_expand(file = 'source_scripts/p_key_period_dispatch_total.Rmd', period.name = period.name)
        } else {key.period.dispatch.total  = 'Section not run according to input file.'}
        
        # Check if zonal dispatch stacks were selected in input file.
        if (key.period.dispatch.zone.log) {
          for ( z in 1:length(zone.names) ) {
            zone.name = zone.names[z]
            key.plots.zone[[z.idx]] = knit_expand(file = 'source_scripts/p_key_period_dispatch_zone.Rmd', period.name = period.name, zone.name = zone.name) 
            z.idx = z.idx + 1
          } 
        } else {key.period.dispatch.zone   = 'Section not run according to input file.'}
        
        # Check if regional dispatch stacks were selected in input file.
        if (key.period.dispatch.region.log) {
          for ( r in 1:length(region.names) ) {
            region.name = region.names[r]
            key.plots.region[[r.idx]] = knit_expand(file = 'source_scripts/p_key_period_dispatch_region.Rmd', period.name = period.name, region.name = region.name)
            r.idx = r.idx + 1
          }
        } else {key.period.dispatch.region = 'Section not run according to input file.'}
      }
  
      # Reconstruct the plot data into a format that will be output into the HTML below
      if (key.period.dispatch.total.log) { key.period.dispatch.total = knit_child(text = unlist(key.plots.total)) }
      if (key.period.dispatch.zone.log) { key.period.dispatch.zone = knit_child(text = unlist(key.plots.zone)) }
      if (key.period.dispatch.region.log) { key.period.dispatch.region = knit_child(text = unlist(key.plots.region)) }
    }
  } else {
    key.period.dispatch.total  = 'Problem sourcing or running d_key_period_dispatch.R.'
    key.period.dispatch.zone   = 'Problem sourcing or running d_key_period_dispatch.R.'
    key.period.dispatch.region = 'Problem sourcing or running d_key_period_dispatch.R.'
  }
} else { key.period.dispatch.total  = 'Section not run according to input file.'
         key.period.dispatch.zone   = 'Section not run according to input file.' 
         key.period.dispatch.region = 'Section not run according to input file.' }
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

### 5. Total
`r key.period.dispatch.total`

***
### 6. Zones
`r key.period.dispatch.zone`

***
### 7. Regions
`r key.period.dispatch.region`

***
## 8-9. Curtailment
***
### 8. Average Daily Curtailment
```{r yearly-curtailment}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/p_daily_curtailment.R')
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
### 9. Average Interval Curtailment
```{r daily-curtailment}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/p_interval_curtailment.R')
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 10. Total Gen
```{r annual-generation-table}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/t_annual_generation.R')
if(exists('yr.gen')) { kable(yr.gen, format.args = list(big.mark = ','), digits=2) }
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 11. Total Costs
```{r annual-cost-table}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/t_annual_cost.R')
if(exists('cost.table')) { kable(cost.table, format.args = list(big.mark = ',')) }
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 12. Region and Zone Info (GWh)
``` {r region-zone-flow-tables}
source('source_scripts/t_region_zone_flow.R')
if(exists('r.stats')) { kable(r.stats, format.args = list(big.mark = ','), digits=2) }
if(exists('z.stats')) { kable(z.stats, format.args = list(big.mark = ','), digits=2) }
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 13. Interface Flow Table
```{r interface-flow-table}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/t_interface_flow.R')
if(exists('annual.flows')) { kable(annual.flows, digits=3) }
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 14. Interface Flow Plots
```{r interface-flow-plots, resize.width=T, fig.width=10}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/p_interface_flow.R')
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 15. Specified Period Interface Flow Plot
```{r key-period-interface-flow-plots, include=FALSE}
if (key.period.interface.flow.plots) {

  # Pull out interface flow data for only specified periods in input file
  source('source_scripts/d_key_period_interface_flow.R')
  
  # As long as the file exists (previous source found the R script) this loop runs
  if ( exists('plot.flows') ) {
    # Check to see if the right data is ready for plotting.
    if ( typeof(plot.flows)=='character' ) {
      print('ERROR: interval_interface_flows function not returning correct results.')
    } else {
    
      key.plots = list() # Creates empty list for plot data
      
      # Create data for each plot for the interesting periods
      for (p in 1:n.periods) {
        period.name = period.names[p]
        key.plots[[p]] = knit_expand(file = 'source_scripts/p_key_period_interface_flow.Rmd', period.name = period.name)
      }
    
      # Reconstruct the plot data into a format that will be output into the HTML below
      key.period.interface.flow = knit_child(text = unlist(key.plots))
   
    }
  } else { key.period.interface.flow = 'Problem sourcing or running d_key_period_interface_flow.R.' }
  
} else { key.period.interface.flow = 'Section not run according to input file.' }
```
`r key.period.interface.flow`

***
## 16-17. Reserves
***
### 16. Annual Reserve Provisions and Shortage
```{r annual-reserves-table}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/t_annual_reserves.R')
if(exists('annual.reserves')) { kable(annual.reserves, format.args = list(big.mark = ',')) }
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
### 17. Average Interval and Daily Reserve Provisions
```{r reserves-plots}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/p_reserves.R')
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 18. Region and Zone Generation (GWh)
```{r region-zone-gen-table}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/t_region_zone_gen.R')
if(exists('r.gen.table')) { kable(r.gen.table, digits=2, format.args = list(big.mark = ',')) }
if(exists('z.gen.table')) { kable(z.gen.table, digits=2, format.args = list(big.mark = ',')) }
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 19. Capacity Factors
```{r capacity-factor-table}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/t_capacity_factor.R')
if(exists('cf')) { kable(cf, format.args = list(big.mark = ','), digits=2) }
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 20. Region Price Duration Curves
```{r price-duration-curve}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
source('source_scripts/p_price_duration_curve.R')
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

***
## 21-22. DA-RT Committment and Dispatch Plots
```{r committment-dispatch, include=FALSE}
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# Check if this section was selected to run in the input file
if (commit.dispatch.region | commit.dispatch.zone) {
  
  source('source_scripts/d_DA_RT_commit_dispatch.R') # Call this R script which created the data needed for plotting.
  
  # As long as the file exists (previous source found the R script) this loop runs
  if ( exists('plot.data.all') ) {
    # Check to see if the right data is ready for plotting.
    if ( typeof(plot.data.all)=='character' ) {
      print('ERROR: cap_committed function not returning correct results.')
    } else {
  
      da.rt.zone = list() # Creates empty list for plot data
      da.rt.region = list() # Creates empty list for plot data
      r.idx = 1 # Start the region name index at 1
      z.idx = 1 # Start the zone name index at 1
    
      # Run the loop for each key period requested.
      for ( p in 1:n.periods ) {
        period.name = period.names[p]
      
        # Check if zonal DA-RT plots were selected in input file. If so create a plot for each zone
        if (commit.dispatch.zone) {
          for ( z in 1:length(zone.names) ) {
              zone.name = zone.names[z]
              da.rt.zone[[z.idx]] = knit_expand(file = 'source_scripts/p_DA_RT_commit_dispatch_zone.Rmd', period.name = period.name, zone.name = zone.name) 
              z.idx = z.idx + 1
          } 
        } else {da.rt.zone = 'Section not run according to input file.'}
        
        if (commit.dispatch.region) {  
          # Create a plot for each region.
          for ( r in 1:length(region.names) ) {
              region.name = region.names[r]
              da.rt.region[[r.idx]] = knit_expand(file = 'source_scripts/p_DA_RT_commit_dispatch_region.Rmd', period.name = period.name, region.name = region.name)
              r.idx = r.idx + 1
          }
        } else {da.rt.region = 'Section not run according to input file.'}
        
      }
    
      # Reconstruct the plot data into a format that will be output into the HTML below
      if (commit.dispatch.zone)   { da.rt.zone = knit_child(text = unlist(da.rt.zone)) }
      if (commit.dispatch.region) { da.rt.region = knit_child(text = unlist(da.rt.region)) }

    }
  } else { da.rt.zone = 'Problem sourcing or running d_DA_RT_commit_dispatch.R.'
         da.rt.region = 'Problem sourcing or running d_DA_RT_commit_dispatch.R.'}
  
} else { da.rt.zone = 'Section not run according to input file.'
         da.rt.region = 'Section not run according to input file.' }
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

### 21. Zones
`r da.rt.zone`

### 22. Regions
`r da.rt.region`
